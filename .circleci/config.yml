version: 2.1

executors:
  docker_build:
    machine:
      docker_layer_caching: true
      image: ubuntu-2004:202010-01

orbs:
  node: circleci/node@5.0
  aws-cli: circleci/aws-cli@3.1.3
  slack: circleci/slack@4.4.4

jobs:
  deploy-tenant-merchant-sample:
    executor: docker_build
    steps:
      - checkout
      - aws-cli/setup:
          aws-access-key-id: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_DEFAULT_REGION
          aws-secret-access-key: AWS_DEFAULT_REGION
          override-installed: true
          version: 2.8.4
      # - run:
      #     command: |
      #       sudo curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-arm64/lightsailctl" -o "/usr/local/bin/lightsailctl"
      #       sudo chmod +x /usr/local/bin/lightsailctl
      - run:
          command: |
            aws --version
            aws lightsail --version
            docker build ./nginx/ -t openfabric-integration-samples-nginx:latest
            docker images
            aws lightsail push-container-image --region ap-southeast-1 --service-name account-merchant-sample --label openfabric-sample-reverse-proxy --image openfabric-integration-samples-nginx:latest
      
workflows:
  dev-deploy:
    jobs:
      - deploy-tenant-merchant-sample:
          context:
            - dev-aws-creds
            - dev-heroku-sample
          filters:
            branches:
              only:
                - main
                - chore/migrate-heroku-to-aws