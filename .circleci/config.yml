version: 2.1

executors:
  docker_build:
    machine:
      docker_layer_caching: true
      image: ubuntu-2004:202010-01

orbs:
  node: circleci/node@5.0
  aws-cli: circleci/aws-cli@3.1.3
  slack: circleci/slack@4.4.4

jobs:
  deploy-tenant-merchant-sample:
    executor: docker_build
    steps:
      - checkout
      - aws-cli/setup:
          aws-access-key-id: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_DEFAULT_REGION
          aws-secret-access-key: AWS_DEFAULT_REGION
          override-installed: true
          version: 2.8.4
      - run:
          command: |
            sudo curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-arm64/lightsailctl" -o "/usr/local/bin/lightsailctl"
            sudo chmod +x /usr/local/bin/lightsailctl
      - run:
          command: |
            which aws
            aws --version
            aws lightsail --version
      - run:
          command: |
            docker build ./nginx/ -t openfabric-integration-samples-nginx:latest
            docker build ./merchant-integration-sample/ -t merchant-integration-sample:latest --build-arg ENV=dev --build-arg PAYMENT_GATEWAY_NAME=xendit --build-arg PAYMENT_GATEWAY_PUBLISH_KEY=xnd_public_development_AZVI4iAxXD6fCgKzxhy1Rvr5obpIvKcJXNnXldhfjhJbWB7RDhwzakaf2dF3tQM
            docker build ./account-integration-sample/ -t account-integration-sample:latest
            docker images
      - run:
          command: |
            aws lightsail push-container-image --region ap-southeast-1 --service-name account-merchant-sample --label openfabric-sample-reverse-proxy --image openfabric-integration-samples-nginx:latest
            aws lightsail push-container-image --region ap-southeast-1 --service-name account-merchant-sample --label merchant-integration --image merchant-integration-sample:latest
            aws lightsail push-container-image --region ap-southeast-1 --service-name account-merchant-sample --label account-integration --image account-integration-sample:latest
      
workflows:
  dev-deploy:
    jobs:
      - deploy-tenant-merchant-sample:
          context:
            - dev-aws-creds
            - dev-heroku-sample
          filters:
            branches:
              only:
                - main
                - chore/migrate-heroku-to-aws